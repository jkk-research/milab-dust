<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script src="script/DustBase.js"></script>
<script src="script/DustTokens.js"></script>
<script src="script/DustSrv.js"></script>
<script src="script/DustModel.js"></script>
<script src="script/DustView.js"></script>
<script src="script/DustControl.js"></script>

<script src="https://js.cytoscape.org/js/cytoscape.min.js"></script>

<title>DustJS Test01</title>

<style>
table, th, td {
	border: 1px solid black;
}

textarea {
	width: 100%;
	height: 200px;
}
</style>

</head>
<body>
	<h1>DustJS JSON:API test</h1>

	<table style="width: 100%">
		<tbody>
			<tr>
				<td width="150px"><label for="path">Path</label></td>
				<td><input style="width: 100%" id="path" value="giskard-2" /></td>
			</tr>
			<tr>
				<td><label for="include">include</label></td>
				<td><input style="width: 100%" id="include" value="111" /></td>
			</tr>
			<tr>
				<td><label for="fields">fields[]*</label></td>
				<td><input style="width: 100%" id="fields" value="222" /></td>
			</tr>
			<tr>
				<td><label for="filter">filter</label></td>
				<td><input style="width: 100%" id="filter" value="333" /></td>
			</tr>
			<tr>
				<td><label for="sort">sort</label></td>
				<td><input style="width: 100%" id="sort" value="" /></td>
			</tr>
			<tr>
				<td><label for="page[offset]">page[offset]</label></td>
				<td><input style="width: 100%" id="page[offset]" value="" /></td>
			</tr>
			<tr>
				<td><label for="page[limit]">page[limit]</label></td>
				<td><input style="width: 100%" id="page[limit]" value="444" /></td>
			</tr>
			<tr>
				<td colspan="2" width="800px"><input type="button"
					value="Get data!"
					onclick="getJsonData('path', 'include', 'fields', 'filter', 'sort', 'page[offset]', 'page[limit]');" />
					<input type="button" value="Stop!"
					style="float: right; background-color: red;"
					onclick="directRequest('/admin/stop');"> <input
					type="button" value="Server info" style="float: right;"
					onclick="directRequest('/admin/info');"></td>
			</tr>
			<tr>
				<td><textarea id='srvResponse'></textarea></td>
				<td><div style="width: 800px; height: 500px; display: block;"
						id='graph'></div></td>
			</tr>
		</tbody>
	</table>

	<script>
		function getJsonData(url, ... params) {			
			var request = {};
			var data = null;
			
			var val = document.getElementById(url);
			val = val.value;

			request.url = "/jsonapi/" + val;
			request.respProc = loadResponseData;
			
			for ( p of params ) {
				val = document.getElementById(p);
				val = val.value;
				if ( val ) {
					if ( !data ) {
						data = {};
						request.data = data;
					}
					data[p] = val;
				}
			}
			
			DustBase.Srv.loadResource(request);
		}
		
		function directRequest(target) {	
			DustBase.Srv.loadResource({ url: target, respProc: displayResponse});
		}
		
		function loadResponseData(id, success, status, data) {	
			var respArr = data.data;
			
			cy.startBatch();
			
			cy.elements.length = 0;
			
			var items = {};
			
			for ( item of respArr ) {
				var itemId = item.id.split(' ')[0];
				items[itemId] = cy.add({ group: 'nodes', data: { id: itemId, label: item.id }});
			}
			
			for ( item of respArr ) {
				var rel = item.relationships;
				
				if ( rel ) {
					var itemId = item.id.split(' ')[0];
					for (const r in rel) {
						var targetId = rel[r].id.split(' ')[0];
						if ( !items[targetId] ) {
							items[targetId] = cy.add({ group: 'nodes', data: { id: targetId, label: rel[r].id }});
						}
						cy.add({ group: 'edges', data: { source: itemId, target: targetId, label: r } });
					}
				}
			}
			
			cy.endBatch();
			
			cy.layout({
					name: 'breadthfirst',
					fit: true,
					directed: true,
					padding: 10
				});
			
			var txt = JSON.stringify(data);
			displayResponse(id, success, status, txt);
		}
		
		function displayResponse(id, success, status, txt) {	
			console.log('Request success ' + txt);
			var ta = document.getElementById('srvResponse');
			ta.value = txt;
		}
		
	  window.cy = cytoscape({
	    container: document.getElementById('graph'),
	    style: [
	        {
	          selector: 'node',
	          style: {
	            'label': 'data(label)'
	          }
	        },
	        {
	          selector: 'edge',
	          style: {
	            'label': 'data(label)'
	          }
	        }
	      ]
	  });
		
	</script>
</body>
</html>