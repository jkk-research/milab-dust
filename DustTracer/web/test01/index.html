<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script src="script/DustBase.js"></script>
<script src="script/DustTokens.js"></script>
<script src="script/DustSrv.js"></script>
<script src="script/DustModel.js"></script>
<script src="script/DustView.js"></script>
<script src="script/DustControl.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>

<title>DustJS Test01</title>

<style>
table, th, td {
	border: 1px solid black;
}

textarea {
	width: 100%;
	height: 200px;
}
</style>

</head>
<body>
	<h1>DustJS JSON:API test</h1>

	<table style="width: 100%">
		<tbody>
			<tr>
				<td width="150px"><label for="path">Path</label></td>
				<td><input style="width: 100%" id="path" value="giskard" /></td>
			</tr>
			<tr>
				<td><label for="include">include</label></td>
				<td><input style="width: 100%" id="include" value="111" /></td>
			</tr>
			<tr>
				<td><label for="fields">fields[]*</label></td>
				<td><input style="width: 100%" id="fields" value="222" /></td>
			</tr>
			<tr>
				<td><label for="filter">filter</label></td>
				<td><input style="width: 100%" id="filter" value="333" /></td>
			</tr>
			<tr>
				<td><label for="sort">sort</label></td>
				<td><input style="width: 100%" id="sort" value="" /></td>
			</tr>
			<tr>
				<td><label for="page[offset]">page[offset]</label></td>
				<td><input style="width: 100%" id="page[offset]" value="" /></td>
			</tr>
			<tr>
				<td><label for="page[limit]">page[limit]</label></td>
				<td><input style="width: 100%" id="page[limit]" value="444" /></td>
			</tr>
			<tr>
				<td colspan="2" width="800px"><input type="button"
					value="Get data!"
					onclick="getJsonData('path', 'include', 'fields', 'filter', 'sort', 'page[offset]', 'page[limit]');" />
					<input type="button" value="Stop!"
					style="float: right; background-color: red;"
					onclick="directRequest('/admin/stop');"> <input
					type="button" value="Server info" style="float: right;"
					onclick="directRequest('/admin/info');"></td>
			</tr>
			<tr>
				<td><textarea id='srvResponse'></textarea></td>
				<td width="80%"><div style="width: 100%; height: 500px; display: block;"
						id='graph'></div></td>
			</tr>
		</tbody>
	</table>

	<script>
		function getJsonData(url, ... params) {			
			var request = {};
			var data = null;
			
			var val = document.getElementById(url);
			val = val.value;

			request.url = "/jsonapi/" + val;
			request.respProc = loadResponseData;
			
			for ( p of params ) {
				val = document.getElementById(p);
				val = val.value;
				if ( val ) {
					if ( !data ) {
						data = {};
						request.data = data;
					}
					data[p] = val;
				}
			}
			
			DustBase.Srv.loadResource(request);
		}
		
		function directRequest(target) {	
			DustBase.Srv.loadResource({ url: target, respProc: displayResponse});
		}
		
		function loadResponseData(id, success, status, data) {	
			var txt = JSON.stringify(data);
			displayResponse(id, success, status, txt);

			var respArr = data.data;
			
			cy.startBatch();
			
			var all = cy.elements('node[id]');
			cy.remove(all);
			
			var items = {};
			
			for ( item of respArr ) {
				var itemId = item.id.split(' ')[0];
				if ( !items[itemId] ) {
					items[itemId] = cy.add({ group: 'nodes', data: { id: itemId, label: item.id }});
				}
			}
			
			for ( item of respArr ) {
				var rel = item.relationships;
				
				if ( rel ) {
					var itemId = item.id.split(' ')[0];
					for (const r in rel) {
						var t = rel[r];
						t = ( Array.isArray(t) ) ? t : [t];
						
						for ( target of t ) {
							var targetId = target.id.split(' ')[0];
							if ( !items[targetId] ) {
								items[targetId] = cy.add({ group: 'nodes', data: { id: targetId, label: target.id }});
							}
							cy.add({ group: 'edges', data: { source: itemId, target: targetId, label: r } });
						}
					}
				}
			}
			
			cy.endBatch();
			
// 			var l = cy.layout({
// 					name: 'breadthfirst',
// 					fit: true,
// 					directed: true,
// 					padding: 10
// 				});
//			l.run();
	
			let options = {
			  name: 'cose',
			
			  ready: function(){},
			  stop: function(){},
			
			  animate: true,
			
			  animationEasing: undefined,
			  animationDuration: undefined,
			
			  animateFilter: function ( node, i ){ return true; },
			  animationThreshold: 250,
			  refresh: 2,
			  fit: true,
			  padding: 30,
			
			  boundingBox: undefined,
			  nodeDimensionsIncludeLabels: false,
			
			  randomize: false,
			  componentSpacing: 40,
			  nodeRepulsion: function( node ){ return 2048; },
			  nodeOverlap: 4,
			  idealEdgeLength: function( edge ){ return 32; },
			  edgeElasticity: function( edge ){ return 32; },
			  nestingFactor: 1.2,
			  gravity: 1,
			  numIter: 1000,
			  initialTemp: 1000,
			  coolingFactor: 0.99,
			  minTemp: 1.0
			};
			
			var layout = cy.layout( options );
			layout.run();			
		}
		
		function displayResponse(id, success, status, txt) {	
			console.log('Request success ' + txt);
			var ta = document.getElementById('srvResponse');
			ta.value = txt;
		}
		
	  window.cy = cytoscape({
	    container: document.getElementById('graph'),
	    style: [
	        {
	          selector: 'node',
	          style: {
	            'label': 'data(label)'
	          }
	        },
	        {
	          selector: 'edge',
	          style: {
	            'label': 'data(label)'
	          }
	        }
	      ]
	  });
		
	</script>
</body>
</html>